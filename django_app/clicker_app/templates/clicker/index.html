{% extends 'clicker/base.html' %}

{% block title %}–ì–ª–∞–≤–Ω–∞—è - Hamster Combat{% endblock %}

{% block content %}
<div class="balance" id="balance">{{ player.balance }} –º–æ–Ω–µ—Ç</div>

<div class="energy-bar">
    <div class="energy-fill" id="energy-fill"></div>
</div>
<div class="energy-text" id="energy-text">–≠–Ω–µ—Ä–≥–∏—è: {{ player.energy }} / {{ player.max_energy }}</div>

<div class="character" id="character">üêπ</div>

<!-- Coin animation container -->
<div id="coin-container"></div>
{% endblock %}

{% block scripts %}
<script>
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —ç–Ω–µ—Ä–≥–∏–∏
    let currentEnergy = parseInt("{{ player.energy }}");
    let maxEnergy = parseInt("{{ player.max_energy }}");
    let energyRegenRate = 1; // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ —Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è 1 –≤ —Å–µ–∫—É–Ω–¥—É
    let lastEnergyUpdate = new Date(); // –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —ç–Ω–µ—Ä–≥–∏–∏
    let energyTimer = null; // –¢–∞–π–º–µ—Ä –¥–ª—è —Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —ç–Ω–µ—Ä–≥–∏–∏
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏ –ø–∞–¥–∞—é—â–µ–π –º–æ–Ω–µ—Ç—ã
    function createCoinAnimation() {
        const coin = document.createElement('div');
        coin.innerHTML = 'üíµ';
        coin.className = 'coin';
        
        // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –º–æ–Ω–µ—Ç—É –Ω–∞–¥ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–º
        const character = document.getElementById('character');
        const rect = character.getBoundingClientRect();
        coin.style.left = (rect.left + rect.width / 2 - 12) + 'px';
        coin.style.top = (rect.top - 50) + 'px';
        
        document.body.appendChild(coin);
        
        // –£–¥–∞–ª—è–µ–º –º–æ–Ω–µ—Ç—É –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏
        setTimeout(() => {
            if (coin.parentNode) {
                coin.parentNode.removeChild(coin);
            }
        }, 1000);
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —ç–Ω–µ—Ä–≥–∏–∏
    function updateEnergyDisplay() {
        const energyFillElement = document.getElementById('energy-fill');
        const energyTextElement = document.getElementById('energy-text');
        
        if (energyFillElement) {
            energyFillElement.style.width = (currentEnergy / maxEnergy * 100) + '%';
        }
        
        if (energyTextElement) {
            energyTextElement.textContent = '–≠–Ω–µ—Ä–≥–∏—è: ' + currentEnergy + ' / ' + maxEnergy;
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —ç–Ω–µ—Ä–≥–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—Ä–µ–º–µ–Ω–∏
    function updateEnergy() {
        const now = new Date();
        const secondsPassed = Math.floor((now - lastEnergyUpdate) / 1000);
        
        // –ï—Å–ª–∏ –ø—Ä–æ—à–ª–∞ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ —Å–µ–∫—É–Ω–¥–∞ –∏ —ç–Ω–µ—Ä–≥–∏—è –Ω–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞
        if (secondsPassed > 0 && currentEnergy < maxEnergy) {
            const energyToAdd = Math.min(secondsPassed * energyRegenRate, maxEnergy - currentEnergy);
            currentEnergy = Math.min(currentEnergy + energyToAdd, maxEnergy);
            lastEnergyUpdate = now;
            updateEnergyDisplay();
        }
        
        // –ï—Å–ª–∏ —ç–Ω–µ—Ä–≥–∏—è –¥–æ—Å—Ç–∏–≥–ª–∞ –º–∞–∫—Å–∏–º—É–º–∞, –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–µ—Ä
        if (currentEnergy >= maxEnergy) {
            stopEnergyRegen();
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —ç–Ω–µ—Ä–≥–∏–∏
    function startEnergyRegen() {
        if (energyTimer) {
            clearInterval(energyTimer);
        }
        energyTimer = setInterval(updateEnergy, 1000); // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —ç–Ω–µ—Ä–≥–∏–∏
    function stopEnergyRegen() {
        if (energyTimer) {
            clearInterval(energyTimer);
            energyTimer = null;
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º
    function syncWithServer() {
        fetch('{% url "player_profile" %}')
        .then(response => response.json())
        .then(data => {
            currentEnergy = data.energy;
            maxEnergy = data.max_energy;
            energyRegenRate = data.energy_regen_rate || 1;
            lastEnergyUpdate = new Date();
            updateEnergyDisplay();
            
            // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä —Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
            if (currentEnergy < maxEnergy) {
                startEnergyRegen();
            } else {
                stopEnergyRegen();
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º:', error);
        });
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —à–∏—Ä–∏–Ω—É –ø–æ–ª–æ—Å—ã —ç–Ω–µ—Ä–≥–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', function() {
        updateEnergyDisplay();
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º —Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—é —ç–Ω–µ—Ä–≥–∏–∏, –µ—Å–ª–∏ —ç–Ω–µ—Ä–≥–∏—è –Ω–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞
        if (currentEnergy < maxEnergy) {
            startEnergyRegen();
        }
        
        // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º (–∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥)
        setInterval(syncWithServer, 30000);
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –ø–µ—Ä—Å–æ–Ω–∞–∂—É
    document.getElementById('character').addEventListener('click', function() {
        // –°–æ–∑–¥–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –º–æ–Ω–µ—Ç—ã
        createCoinAnimation();
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ª–∏ —ç–Ω–µ—Ä–≥–∏–∏
        if (currentEnergy < 1) {
            alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —ç–Ω–µ—Ä–≥–∏–∏!');
            return;
        }
        
        // –ü–æ–ª—É—á–∞–µ–º CSRF —Ç–æ–∫–µ–Ω –∏–∑ cookie
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
        const data = {
            clicks: 1,
            timestamp: new Date().toISOString(),
            energy: currentEnergy,
            balance: parseInt(document.getElementById('balance').textContent)
        };
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º AJAX-–∑–∞–ø—Ä–æ—Å
        fetch('{% url "clicker:click" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å
            const balanceElement = document.getElementById('balance');
            if (balanceElement) {
                balanceElement.textContent = data.balance + ' –º–æ–Ω–µ—Ç';
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —ç–Ω–µ—Ä–≥–∏—é –∏–∑ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞
            currentEnergy = data.energy;
            maxEnergy = data.max_energy;
            lastEnergyUpdate = new Date();
            updateEnergyDisplay();
            
            // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä —Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
            if (currentEnergy < maxEnergy) {
                startEnergyRegen();
            } else {
                stopEnergyRegen();
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç
            const character = document.getElementById('character');
            character.style.transform = 'scale(0.95)';
            setTimeout(() => {
                character.style.transform = 'scale(1)';
            }, 100);
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞:', error);
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
            alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∫–ª–∏–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
        });
    });
</script>
{% endblock %}