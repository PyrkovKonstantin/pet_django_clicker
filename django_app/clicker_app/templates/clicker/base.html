<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Hamster Combat Clone{% endblock %}</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/clicker.css' %}">
</head>
<body>
    <div class="container">
        <header>
            <h1>{% block header %}Hamster Combat{% endblock %}</h1>
        </header>
        
        <div class="content">
            {% block content %}
            {% endblock %}
        </div>
    </div>
    
    <nav>
        <a href="{% url 'clicker:index' %}" class="nav-item {% if request.resolver_match.url_name == 'index' %}active{% endif %}">
            <span class="nav-icon">üè†</span>
            <span>–ì–ª–∞–≤–Ω–∞—è</span>
        </a>
        <a href="{% url 'clicker:upgrades' %}" class="nav-item {% if request.resolver_match.url_name == 'upgrades' %}active{% endif %}">
            <span class="nav-icon">‚öôÔ∏è</span>
            <span>–£–ª—É—á—à–µ–Ω–∏—è</span>
        </a>
        <a href="{% url 'clicker:tasks' %}" class="nav-item {% if request.resolver_match.url_name == 'tasks' %}active{% endif %}">
            <span class="nav-icon">üìã</span>
            <span>–ó–∞–¥–∞–Ω–∏—è</span>
        </a>
        <a href="{% url 'clicker:daily_reward' %}" class="nav-item {% if request.resolver_match.url_name == 'daily_reward' %}active{% endif %}">
            <span class="nav-icon">üéÅ</span>
            <span>–ë–æ–Ω—É—Å</span>
        </a>
        
        <!-- Authentication links -->
        {% if user.is_authenticated %}
            <a href="#" class="nav-item" id="logout-link">
                <span class="nav-icon">üö™</span>
                <span>–í—ã–π—Ç–∏ ({{ user.username }})</span>
            </a>
        {% else %}
            <a href="{% url 'clicker:login' %}" class="nav-item">
                <span class="nav-icon">üîê</span>
                <span>–í–æ–π—Ç–∏</span>
            </a>
            <a href="{% url 'clicker:register' %}" class="nav-item">
                <span class="nav-icon">üìù</span>
                <span>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</span>
            </a>
        {% endif %}
    </nav>

    <script>
        // –û–±—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ POST –∑–∞–ø—Ä–æ—Å–æ–≤ —Å CSRF —Ç–æ–∫–µ–Ω–æ–º
        function sendPostRequest(url, data, successCallback) {
            // –ü–æ–ª—É—á–∞–µ–º CSRF —Ç–æ–∫–µ–Ω –∏–∑ cookie
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            // –î–æ–±–∞–≤–ª—è–µ–º CSRF —Ç–æ–∫–µ–Ω –∫ –¥–∞–Ω–Ω—ã–º
            data.csrfmiddlewaretoken = getCookie('csrftoken');

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º POST –∑–∞–ø—Ä–æ—Å
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    successCallback(data);
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + data.error);
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–∞');
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
        function updateBalance(newBalance) {
            const balanceElement = document.querySelector('.balance');
            if (balanceElement) {
                balanceElement.textContent = newBalance + ' –º–æ–Ω–µ—Ç';
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —ç–Ω–µ—Ä–≥–∏–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
        function updateEnergy(energy, maxEnergy) {
            const energyFillElement = document.querySelector('.energy-fill');
            const energyTextElement = document.querySelector('.energy-text');
            
            if (energyFillElement) {
                energyFillElement.style.width = (energy / maxEnergy * 100) + '%';
            }
            
            if (energyTextElement) {
                energyTextElement.textContent = '–≠–Ω–µ—Ä–≥–∏—è: ' + energy + ' / ' + maxEnergy;
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã—Ö–æ–¥–∞
        document.addEventListener('DOMContentLoaded', function() {
            const logoutLink = document.getElementById('logout-link');
            if (logoutLink) {
                logoutLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    sendPostRequest('{% url "clicker:logout" %}', {}, function(data) {
                        if (data.success) {
                            window.location.href = '{% url "clicker:index" %}';
                        }
                    });
                });
            }
        });
    </script>
    
    {% block scripts %}
    {% endblock %}
</body>
</html>